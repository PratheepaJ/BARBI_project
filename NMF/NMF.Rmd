---
title: "NMF"
author: "Pratheepa Jeganathan"
date: "6/19/2019"
output: 
    html_document:
        toc: true
---

We have 10 negative control samples and serial dilution of ZymoBIOMICS® Microbial Community Standard.

Looking at the DADA2 pipeline ASVs 2, 3, 4, 5, 6, 7, 8, 11, 17, 37, 22 are in the ZymoBIOMICS® Microbial Community Standard.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
  message = FALSE, 
  warning = FALSE, 
  fig.width = 16, 
  fig.height = 10)
```


```{r eval=FALSE, include=FALSE}
pkgs = c("phyloseq", 
  "ggplot2", 
  "magrittr", 
  "dplyr", 
  "reshape2", 
  "RColorBrewer", 
  "wesanderson",
  "DESeq2",
  "NMF")

if (!requireNamespace("BiocManager")){
  install.packages("BiocManager")
}
    
BiocManager::install(setdiff(pkgs, installed.packages()), 
  update = TRUE)

```

Loading packages
```{r}
library(phyloseq)
library(ggplot2)
library(magrittr)
library(dplyr)
library(reshape2)
# library(rstan)
library(RColorBrewer)
library(wesanderson)
#devtools::install_github("jakobbossek/ggheatmap")
library(ggheatmap)
library(DESeq2)
library(NMF)
```


## Read phyloseq and exploratory analysis

```{r}
ps = readRDS("./Data/ps_zymo.rds")
if(dim(otu_table(ps))[1]!=ntaxa(ps)){
  otu_table(ps) = t(otu_table(ps))
  }
```

change order of sample names
```{r}
ncont = paste0("NegativeControl.", seq(1, 10))
stan = paste0("Standard.Dilution.1.",c(1, 6, 36, 216, 1296, 7776, 46656, 279936))

sample_data(ps)$Name = factor(sample_data(ps)$Name, levels = c(ncont,stan))

sample_names(ps) = as.character(sample_data(ps)$Name)
```

Store sequence variants, ASVs, ASV.genus, ASV.genus.species
```{r}
ASV = as.character(paste0("ASV_", seq(1,ntaxa(ps))))

ASV.Genus = paste0("ASV_", seq(1,ntaxa(ps)), "_", as.character(tax_table(ps)[,6]))

ASV.Genus.Species = paste0(ASV, "_", as.character(tax_table(ps)[,6]), "_", as.character(tax_table(ps)[,7]))

df.ASV = data.frame(seq.variant = taxa_names(ps), ASV = ASV, ASV.Genus = ASV.Genus, ASV.Genus.Species = ASV.Genus.Species)
```


```{r }
taxa_names(ps) = df.ASV$ASV.Genus
```

## Microbial composition of the ZymoBIOMICS® microbial community standard (Zymo Research, Irvine, CA) measured 

True ASVs at genus level

```{r}
# true.com.ASV = taxa_names(ps)[which(tax_table(ps)[,6] %in% c("Bacillus","Listeria","Staphylococcus", "Lactobacillus", "Escherichia/Shigella", "Enterococcus", "Salmonella", "Pseudomonas"))]
true.com.ASV = taxa_names(ps)[c(2:8,11,17,37,22)]
ps.true = transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.true = prune_taxa(true.com.ASV, ps.true)
ps.true
```


### Create a list of true ASVs in each diluted sample

```{r}
true.com.ASV = taxa_names(ps)[c(2:8,11,17,22,37)]
# true.com.ASV = taxa_names(ps)[which((tax_table(ps)[,6] %in% c("Bacillus","Listeria","Staphylococcus", "Lactobacillus", "Escherichia/Shigella", "Enterococcus", "Salmonella", "Pseudomonas")))]

# true.com.ASV = taxa_names(ps)[which((tax_table(ps)[,6] %in% c("Bacillus","Listeria","Staphylococcus", "Lactobacillus", "Escherichia/Shigella", "Enterococcus", "Salmonella", "Pseudomonas"))&(!is.na(tax_table(ps)[,7])))]

diluted.sample.names = sample_names(ps)[3:10]

trueSeq = function(sample.name, true.com.ASV){
  df.sample.i = data.frame(ot = otu_table(ps)[, sample.name])
  names(df.sample.i) = "ot"
  df.sample.i = mutate(df.sample.i, ASV = rownames(df.sample.i))
  df.sample.i.true.seq = filter(df.sample.i, (ot > 0) & (as.character(ASV) %in% true.com.ASV))
  true.seq.sample.i = as.character(df.sample.i.true.seq$ASV)
  return(true.seq.sample.i)
}


true.seq.all.samples = lapply(diluted.sample.names, FUN = trueSeq, true.com.ASV = true.com.ASV)

##true.seq.all.samples
```

### Number of true ASVs in each dilution series sample
```{r}
number.of.true.ASVs = lapply(true.seq.all.samples, 
  function(x) {length(x)})
number.of.true.ASVs
```

### Number of unique true ASV in all samples
```{r}
number.of.unique.ASVs.in.all.samples = length(unique(unlist(true.seq.all.samples)))
number.of.unique.ASVs.in.all.samples
```


### Check the percentage of eleven ASVs in each dilution series sample

```{r}
ps.prop = transform_sample_counts(ps, function(otu) otu/sum(otu)*100)
ps.true = prune_taxa(unique(unlist(true.seq.all.samples)), ps)
ps.prop.true = prune_taxa(taxa_names(ps.true), ps.prop)
dt = otu_table(subset_samples(ps.prop.true, 
  SampleType == "Standard")) %>% data.frame()
colnames(dt) = sample_data(subset_samples(ps.prop.true, 
  SampleType == "Standard"))$Name
#rownames(dt) = df.ASV$ASV.Genus[which(as.character(df.ASV$ASV.Genus.Species) %in% rownames(dt))]
#rownames(dt) = df.ASV$ASV.Genus.Species[which(as.character(df.ASV$ASV.Genus.Species) %in% rownames(dt))]
rownames(dt) = df.ASV$ASV.Genus[which(as.character(df.ASV$ASV.Genus) %in% rownames(dt))]
dt = round(dt, digits = 0)
library(knitr)
kable(dt)
```

### Adding blocks

We have only one block of samples.

```{r adding_blocks}
blocks = rep("Set1", nsamples(ps))

sample_data(ps)$block = blocks
```

Identify the species that are not present in at least one `SampleType == Standard` sample and removed them from the phyloseq object. Label these species as contaminants. 

```{r filter_taxa}
ps = prune_taxa(taxa_sums(ps) > 0, ps)
ps.standard = subset_samples(ps, SampleType %in% c("Standard"))
prevTaxaP = apply(otu_table(ps.standard), 1, function(x){sum(x>0)})

Contaminants1 = names(prevTaxaP)[prevTaxaP == 0]
length(Contaminants1)
```

```{r}
ps = prune_taxa(prevTaxaP > 0, ps)
ps
```

We identified 142 ASVs not is any dilution series samples and they are classified as contaminants before using LDA.
  
See a summary of the `Standard` and `Negative` samples in each block. 

```{r summary_stat}
table(sample_data(ps)$SampleType, sample_data(ps)$block)
```

```{r}
colSums(otu_table(ps))
```

##      Prepare the phyloseq object for the Bayesian inference

We use Bayesian inference to identify contaminants in each block separately to account for the batch-effects of contamination. In Zymo data, we have batch effects.

Thus, split the phyloseq object into multiple phyloseq objects corresponding to each block, and store the phyloseq objects as a list of phyloseq objects, `psByBlock`. 

Select negative control samples from each block and store as a list of phyloseq objects, `psNCbyBlock`. 

Select all species that have a prevalence of zero (i.e., have zero reads) in all negative control samples for each block and store as a list of phyloseq objects, `psallzeroInNC`.

Select all plasma samples from each block and store as a list of phyloseq objects, `psPlByBlock`.

```{r list_of_phyloseq}
source("psBlockResults.R")
psBlockResult = psBlockResults(ps, 
  sampleTypeVar = "SampleType", caselevels = c("Standard"), controllevel="Negative", sampleName = "Name", blockVar = "block")

psByBlock = psBlockResult[[1]]
psNCbyBlock = psBlockResult[[2]]
psallzeroInNC = psBlockResult[[3]]
psPlByBlock = psBlockResult[[4]]
```

## median-of-ratios for each block
```{r}
lambda.blks = lapply(as.list(seq(1,1)), function(i){
    x = psByBlock[[i]]
    if (dim(otu_table(x))[2] != nsamples(x)) {
            otu_table(x) = t(otu_table(x))
        }
    ot = otu_table(x) %>% data.frame %>% as.matrix
    
    geo_mean = function(x) {
            if(all(x == 0)){
                val = 0
            }else{
                val = exp(sum(log(x[x > 0]))/length(x))
            }
            return(val)
    }
    
    geom_mean_row = apply(ot, 1, FUN = geo_mean)
    
    sj = estimateSizeFactorsForMatrix(ot, median, geoMeans = geom_mean_row)
    
    ot_col_sum = colSums(ot)
    ot_col_sum_new  = as.matrix(ot_col_sum) * as.matrix(sj)
    lambda = as.numeric(round(ot_col_sum_new, digits = 0)[,1])
    return(lambda)
})

```


## NMF

$A = WH$, where $A$ is the observed count matrix: variables on the rows and samples on the columns.

$W$ Basis vectors - the topics (clusters) discovered from the document.

$H$ Coefficient matrix - the membership weights for the topics in each sample.


```{r}
x = otu_table(psByBlock[[1]]) %>% data.frame %>% as.matrix
K = 4
res = nmf(x, rank = K, method = "lee")

```

#  ASV proportion in each topic discoverd from the samples
```{r}
W = basis(res) 
df = as.data.frame(W)
head(df)
df$total = rowSums(df)
df$ASV  = rownames(df)
df = df[order(-df$total), ] 
head(df,20)
```

```{r}
ASVMatrix = as.data.frame(W)
ASVMatrix$ASV = rownames(ASVMatrix)
colnames(ASVMatrix)[1:K] = paste0("Topic_", seq(1,K))
```

Plot ASV proportion in each topic
```{r}
col.topic = c(wes_palette("Cavalcanti1", n = 5), wes_palette("Darjeeling1", n = 5))

plot.all = lapply(as.list(seq(1,K)), function(i){
  newdata = ASVMatrix[order(-ASVMatrix[, i]), ] 
  d = newdata
  df = as.data.frame(cbind(d[1:10,]$ASV, as.numeric(d[1:10,][,i])))
  colnames(df) =  c("ASV", "Frequency")
  df$Frequency = as.numeric(df$Frequency)
  df$Frequency = round(df$Frequency, digits = 1)
  
  df$ASV = factor(df$ASV, levels = df$ASV[order(df$Frequency)])
  p = ggplot(df, aes(x = ASV, y = Frequency)) + 
    geom_bar(stat = "identity", fill = col.topic[i], color = "grey50")+
    coord_flip()+
    ggtitle(paste0("Topic " , i)) + theme(axis.text = element_text(size = 14))
  return(p)
})

```

```{r}
plot.all
```

